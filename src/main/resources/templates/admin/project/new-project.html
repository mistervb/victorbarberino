<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/fragments/head('VB Admin - Novo Projeto')}"></head>
<link rel="stylesheet" th:href="@{/css/sidebar.css}">
<link rel="stylesheet" th:href="@{/css/topbar.css}">
<link rel="stylesheet" th:href="@{/css/new-project.css}">
<body>
    <div th:replace="~{/fragments/sidebar :: main_sidebar('projects')}"></div>
    <div class="main-content p-0">
        <nav th:replace="~{/fragments/topbar :: topbar}"></nav>
        <div class="content-wrapper">
            <div class="form-container">
                <div class="form-header-flex">
                    <a href="/admin/projects" class="back-link-ios">
                        <i class="fas fa-chevron-left"></i> Projetos
                    </a>
                    <h1 class="form-title">
                        <i class="fas fa-plus-circle"></i>
                        Novo Projeto
                    </h1>
                </div>
                <form th:action="@{/admin/projects/action/save}" th:object="${projectData}" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label" for="title">Título</label>
                        <input type="text" class="form-control" id="title" th:field="*{title}" required>
                        <span class="error-message" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></span>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="description">Descrição</label>
                        <textarea class="form-control" id="description" th:field="*{description}" rows="4" required></textarea>
                        <span class="error-message" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></span>
                    </div>

                    <div class="form-group">
                        <div class="tab-image-choice">
                            <button type="button" class="tab-btn active" id="tabUrlBtn">URL</button>
                            <button type="button" class="tab-btn" id="tabFileBtn">Arquivo</button>
                        </div>
                        <div id="imageUrlInput">
                            <label class="form-label" for="image">URL da Imagem</label>
                            <input type="url" class="form-control" id="image" th:field="*{image}" placeholder="https://...">
                        </div>
                        <div id="imageFileInput" style="display:none">
                            <label class="form-label" for="imageFile">Upload de Imagem</label>
                            <input type="file" class="form-control" id="imageFile" name="imageFile" accept="image/*">
                        </div>
                        <input type="hidden" id="imageInputType" name="imageInputType" value="url">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="githubUrl">Link do GitHub (opcional)</label>
                        <input type="url" class="form-control" id="githubUrl" th:field="*{githubUrl}" placeholder="https://github.com/seu-usuario/repositorio">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="projectUrl">Link do Projeto (opcional)</label>
                        <input type="url" class="form-control" id="projectUrl" th:field="*{projectUrl}" placeholder="https://seu-projeto.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="newTag">Tags</label>
                        <input type="text" class="form-control" id="newTag" placeholder="Digite uma tag e pressione Enter">
                        <!-- inputs de tags são criados dinamicamente pelo JS -->
                        <div class="tag-container" id="tagContainer"></div>
                    </div>

                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i>
                        Salvar Projeto
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div th:if="${!#lists.isEmpty(notifications)}" th:each="notification : ${notifications}">
        <div th:replace="~{fragments/notifications :: notifications(${notification.type.name().toLowerCase()}, ${notification.message})}"></div>
    </div>

    <script th:inline="javascript">
        const tagInput = document.getElementById('newTag');
        const tagContainer = document.getElementById('tagContainer');
        let tags = /*[[${projectData.tags}]]*/ [];
        if (Array.isArray(tags) && tags.length === 1 && typeof tags[0] === 'string' && tags[0].startsWith('[') && tags[0].endsWith(']')) {
            try {
                tags = JSON.parse(tags[0]);
            } catch (e) {
                tags = [];
            }
        }

        function updateTags() {
            tagContainer.innerHTML = '';
            // Remover todos os campos tags antigos
            document.querySelectorAll('input[name="tags"]').forEach(e => e.remove());
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.innerHTML = `${tag} <i class="fas fa-times"></i>`;
                tagElement.onclick = () => removeTag(tag);
                tagContainer.appendChild(tagElement);

                // Cria um campo hidden para cada tag
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'tags';
                input.value = tag;
                tagContainer.appendChild(input);
            });
        }

        function addTag(tag) {
            tag = tag.trim();
            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                updateTags();
            }
        }

        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            updateTags();
        }

        tagInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag(tagInput.value);
                tagInput.value = '';
            }
        });

        updateTags();
    </script>

    <script>
        // Tabs para escolha de imagem
        const tabUrlBtn = document.getElementById('tabUrlBtn');
        const tabFileBtn = document.getElementById('tabFileBtn');
        const imageUrlInput = document.getElementById('imageUrlInput');
        const imageFileInput = document.getElementById('imageFileInput');
        const imageUrlField = document.getElementById('image');
        const imageFileField = document.getElementById('imageFile');
        const form = imageUrlField.closest('form');
        tabUrlBtn.addEventListener('click', function() {
            tabUrlBtn.classList.add('active');
            tabFileBtn.classList.remove('active');
            imageUrlInput.style.display = '';
            imageFileInput.style.display = 'none';
            document.getElementById('imageInputType').value = 'url';
            // Limpa arquivo, torna URL required
            if (imageFileField) imageFileField.value = '';
            if (imageUrlField) imageUrlField.required = true;
            if (imageFileField) imageFileField.required = false;
        });
        tabFileBtn.addEventListener('click', function() {
            tabFileBtn.classList.add('active');
            tabUrlBtn.classList.remove('active');
            imageUrlInput.style.display = 'none';
            imageFileInput.style.display = '';
            document.getElementById('imageInputType').value = 'file';
            // Limpa URL, torna arquivo required
            if (imageUrlField) imageUrlField.value = '';
            if (imageFileField) imageFileField.required = true;
            if (imageUrlField) imageUrlField.required = false;
        });
        // Validação extra no submit
        if (form) {
            form.addEventListener('submit', function(e) {
                if (tabUrlBtn.classList.contains('active')) {
                    // URL obrigatório
                    if (!imageUrlField.value.trim()) {
                        imageUrlField.focus();
                        e.preventDefault();
                    }
                } else if (tabFileBtn.classList.contains('active')) {
                    // Arquivo obrigatório
                    if (!imageFileField.value) {
                        imageFileField.focus();
                        e.preventDefault();
                    }
                }
            });
        }
    </script>
</body>
</html>