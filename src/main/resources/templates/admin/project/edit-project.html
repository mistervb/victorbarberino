<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/fragments/head('VB Admin - Editar Projeto')}"></head>
<link rel="stylesheet" th:href="@{/css/sidebar.css}">
<link rel="stylesheet" th:href="@{/css/topbar.css}">
<link rel="stylesheet" th:href="@{/css/new-project.css}">
<body>
    <div th:replace="~{/fragments/sidebar :: main_sidebar('projects')}"></div>
    <div class="main-content p-0">
        <nav th:replace="~{/fragments/topbar :: topbar}"></nav>
        <div class="content-wrapper">
            <div class="form-container">
                <div class="form-header-flex">
                    <a href="/admin/projects" class="back-link-ios">
                        <i class="fas fa-chevron-left"></i> Projetos
                    </a>
                    <h1 class="form-title">
                        <i class="fas fa-edit"></i>
                        Editar Projeto
                    </h1>
                </div>
                <form th:action="@{'/admin/projects/action/update/' + ${projectData.projectId}}" th:object="${projectData}" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label" for="title">Título</label>
                        <input type="text" class="form-control" id="title" th:field="*{title}" required>
                        <span class="error-message" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="description">Descrição</label>
                        <textarea class="form-control" id="description" th:field="*{description}" rows="4" required></textarea>
                        <span class="error-message" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pré-visualização da Imagem Atual</label>
                        <div th:if="${projectData.image != null}">
                            <img th:src="${projectData.image}" alt="Imagem atual" style="max-width:200px; max-height:200px; display:block; margin-bottom:8px;">
                        </div>
                        <div th:if="${projectData.image == null}">
                            <span style="color:#999">Nenhuma imagem cadastrada.</span>
                        </div>
                        <small class="form-text text-muted">
                            Se não quiser alterar a imagem, apenas salve. Para trocar, selecione uma nova imagem ou informe uma nova URL.
                        </small>
                    </div>
                    <div class="form-group">
                        <div class="tab-image-choice">
                            <button type="button" class="tab-btn active" id="tabUrlBtn">URL</button>
                            <button type="button" class="tab-btn" id="tabFileBtn">Arquivo</button>
                        </div>
                        <div id="imageUrlInputHidden" th:style="${projectData.wasUploaded} ? '' : 'display:none'">
                            <input type="hidden" id="imageHidden" th:field="*{image}" />
                        </div>
                        <div id="uploadMsg" th:style="${projectData.wasUploaded} ? '' : 'display:none'">
                            <p class="text-muted" style="margin:8px 0;">
                                Você fez upload dessa imagem.
                                <a href="#" id="switchToUrlBtn" style="color:#f6a700; text-decoration:underline; cursor:pointer;">Clique aqui para trocar para uma URL</a>
                                <a href="#" id="switchToFileBtn" style="color:#f6a700; text-decoration:underline; cursor:pointer;">Clique aqui para trocar de arquivo</a>
                            </p>
                        </div>
                        <div id="imageUrlInputVisible" th:style="${projectData.wasUploaded} ? 'display:none' : ''">
                            <label class="form-label" for="imageUrlField">URL da Imagem</label>
                            <input type="url" class="form-control" id="imageUrlField" th:field="*{image}" placeholder="https://...">
                        </div>
                        <div id="imageFileInput" th:style="${projectData.wasUploaded} ? 'display:none' : ''">
                            <label class="form-label" for="imageFile">Upload de Imagem</label>
                            <input type="file" class="form-control" id="imageFile" name="imageFile" accept="image/*">
                        </div>
                        <input type="hidden" id="imageInputType" name="imageInputType" th:value="${projectData.image != null and #strings.startsWith(projectData.image, '/project/img?id=') ? 'file' : 'url'}">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newTag">Tags</label>
                        <input type="text" class="form-control" id="newTag" placeholder="Digite uma tag e pressione Enter">
                        <!-- inputs de tags são criados dinamicamente pelo JS -->
                        <div class="tag-container" id="tagContainer"></div>
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i>
                        Salvar Alterações
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div th:if="${!#lists.isEmpty(notifications)}" th:each="notification : ${notifications}">
        <div th:replace="~{fragments/notifications :: notifications(${notification.type.name().toLowerCase()}, ${notification.message})}"></div>
    </div>
    <script th:inline="javascript">
        const tagInput = document.getElementById('newTag');
        const tagContainer = document.getElementById('tagContainer');
        let tags = /*[[${projectData.tags}]]*/ [];
        if (Array.isArray(tags) && tags.length === 1 && typeof tags[0] === 'string' && tags[0].startsWith('[') && tags[0].endsWith(']')) {
            try {
                tags = JSON.parse(tags[0]);
            } catch (e) {
                tags = [];
            }
        }
        function updateTags() {
            tagContainer.innerHTML = '';
            // Remover todos os campos tags antigos
            document.querySelectorAll('input[name="tags"]').forEach(e => e.remove());
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.innerHTML = `${tag} <i class="fas fa-times"></i>`;
                tagElement.onclick = () => removeTag(tag);
                tagContainer.appendChild(tagElement);
                // Cria um campo hidden para cada tag
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'tags';
                input.value = tag;
                tagContainer.appendChild(input);
            });
        }
        function addTag(tag) {
            tag = tag.trim();
            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                updateTags();
            }
        }
        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            updateTags();
        }
        tagInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag(tagInput.value);
                tagInput.value = '';
            }
        });
        updateTags();
    </script>
    <script th:inline="javascript">
        // Valores padrões conforme wasUploaded
        var wasUploaded = /*[[${projectData.wasUploaded}]]*/ false;
        console.log(wasUploaded);
        document.getElementById('imageInputType').value = wasUploaded ? 'file' : 'url';

        // Tabs para escolha de imagem
        const tabUrlBtn = document.getElementById('tabUrlBtn');
        const tabFileBtn = document.getElementById('tabFileBtn');
        const imageUrlInputHidden = document.getElementById('imageUrlInputHidden');
        const imageUrlInputVisible = document.getElementById('imageUrlInputVisible');
        const imageFileInput = document.getElementById('imageFileInput');
        const imageUrlField = imageUrlInputVisible.querySelector('input[type="url"]');
        const imageFileField = document.getElementById('imageFile');
        const imageHiddenField = document.getElementById('imageHidden');
        const form = imageUrlField.closest('form');
        const switchToUrlBtn = document.getElementById('switchToUrlBtn');
        const switchToFileBtn = document.getElementById('switchToFileBtn');

        // Ativa a tab correta ao carregar
        const initialInputType = document.getElementById('imageInputType').value;
        if (initialInputType === 'file') {
            tabFileBtn.classList.add('active');
            tabUrlBtn.classList.remove('active');
            imageUrlInputVisible.style.display = 'none';
            imageUrlInputHidden.style.display = '';
            
            imageFileInput.style.display = wasUploaded ? 'none' : '';
            switchToUrlBtn.style.display = wasUploaded ? 'none' : '';
            switchToFileBtn.style.display = wasUploaded ? '' : 'none';
            imageUrlField.disabled = true;
            imageHiddenField.disabled = false;
            imageFileField.required = !wasUploaded;
        } else {
            tabUrlBtn.classList.add('active');
            tabFileBtn.classList.remove('active');
            imageUrlInputHidden.style.display = 'none';
            //imageUrlInputVisible.style.display = wasUploaded ? 'none' : 'block';
            imageFileInput.style.display = 'none';
            imageHiddenField.disabled = true;
            imageUrlField.disabled = false;
        }
        tabUrlBtn.addEventListener('click', function() {
            if(wasUploaded) {
                switchToFileBtn.style.display = 'none';
                switchToUrlBtn.style.display = '';
            }
            tabUrlBtn.classList.add('active');
            tabFileBtn.classList.remove('active');

            if(!wasUploaded) {
                imageUrlInputHidden.style.display = 'none';
                imageUrlInputVisible.style.display = '';
                imageFileField.style.display = 'none';
                imageFileInput.style.display = 'none';
                document.getElementById('imageInputType').value = 'url';
                // Limpa arquivo, torna URL required
                if (imageFileField) imageFileField.value = '';
                if (imageFileField) imageFileField.required = false;
                if (imageUrlField) imageUrlField.required = true;
                imageHiddenField.disabled = true;
                imageUrlField.disabled = false;
            }
          
        });
        tabFileBtn.addEventListener('click', function() {
            if(wasUploaded) {
                switchToUrlBtn.style.display = 'none';
                switchToFileBtn.style.display = '';
            }
            tabFileBtn.classList.add('active');
            tabUrlBtn.classList.remove('active');

            if(!wasUploaded) {
                imageUrlInputHidden.style.display = '';
                imageUrlInputVisible.style.display = 'none';
                imageFileField.style.display = '';
                imageFileInput.style.display = '';
                document.getElementById('imageInputType').value = 'file';
                // Limpa URL, torna arquivo required
                if (imageUrlField) imageUrlField.value = '';
                if (imageFileField) imageFileField.required = true;
                if (imageUrlField) imageUrlField.required = false;
                imageUrlField.disabled = true;
                imageHiddenField.disabled = false;
            }
        });
   
        if (switchToUrlBtn) {
            switchToUrlBtn.addEventListener('click', function(e) {
                e.preventDefault();
                // Esconde o input hidden e mostra o visível
                if (imageUrlInputHidden) imageUrlInputHidden.style.display = 'none';
                if (imageUrlInputVisible) imageUrlInputVisible.style.display = '';
                if (imageUrlField) imageUrlField.value = '';
                // Ativa a tab URL
                tabUrlBtn.classList.add('active');
                tabFileBtn.classList.remove('active');
                imageFileInput.style.display = 'none';
                document.getElementById('imageInputType').value = 'url';
                // Esconde a mensagem de upload inteira
                const uploadMsg = document.getElementById('uploadMsg');
                if (uploadMsg) uploadMsg.style.display = 'none';
                imageHiddenField.disabled = true;
                imageUrlField.disabled = false;
                wasUploaded = false;
            });
        }
        if(switchToFileBtn) {
            switchToFileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                imageUrlInputHidden.style.display = '';
                imageUrlInputVisible.style.display = 'none';
                document.getElementById('imageInputType').value = 'file';
                
                // Limpa URL, torna arquivo required
                if (imageUrlField) imageUrlField.value = '';
                if (imageFileField) imageFileField.required = true;
                if (imageUrlField) imageUrlField.required = false;

                const uploadMsg = document.getElementById('uploadMsg');
                if (uploadMsg) uploadMsg.style.display = 'none';

                imageUrlField.disabled = true;
                imageHiddenField.disabled = false;

                imageFileField.style.display = '';
                imageFileInput.style.display = '';

                wasUploaded = false;
            });
        }
        // Validação extra no submit
        if (form) {
            form.addEventListener('submit', function(e) {
                if (tabUrlBtn.classList.contains('active')) {
                    // URL obrigatório
                    if (!imageUrlField.value.trim()) {
                        imageUrlField.focus();
                        e.preventDefault();
                    } 
                } else if (tabFileBtn.classList.contains('active')) {
                    if (!imageFileField.value && wasUploaded) {
            // OK: já existe imagem salva, não precisa uploadar de novo
            return;
        }
                    // Arquivo obrigatório
                    if (!imageFileField.value) {
                        imageFileField.focus();
                        e.preventDefault();
                    }
                }
            });
        }
    </script>
</body>
</html>
